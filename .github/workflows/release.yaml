name: Build & Release

on:
  release:
    types: [published]
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      isHotfix:
        description: "是否为hotfix版本"
        required: true
        type: boolean
        default: false

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          architecture: "x64"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set Version Variables
        id: version
        run: |
          # 提取基础标签名（如v1.2.3）
          echo "BASE_TAG=${{ github.ref_name }}" >> $GITHUB_ENV
          # 判断是否为hotfix
          if "${{ github.event_name }}" == "workflow_dispatch"; then
            echo "IS_HOTFIX=${{ github.event.inputs.isHotfix }}" >> $GITHUB_ENV
          else
            echo "IS_HOTFIX=false" >> $GITHUB_ENV
          fi
          # 生成带hotfix标识的完整版本号
          if [ "${{ env.IS_HOTFIX }}" = "true" ]; then
            echo "FULL_VERSION=${{ env.BASE_TAG }}-hotfix" >> $GITHUB_ENV
          else
            echo "FULL_VERSION=${{ env.BASE_TAG }}" >> $GITHUB_ENV
          fi
        shell: bash

      # 新增：生成version.py文件，用于程序内部读取版本
      - name: Generate version.py
        run: |
          # 写入版本信息到version.py
          echo "__version__ = \"${{ env.FULL_VERSION }}\"" > version.py
          # 打印版本文件内容，用于验证
          cat version.py
        shell: bash

      - name: Generate Changelog
        run: |
          python scripts/generate_changelog.py "${{ env.BASE_TAG }}" > CHANGELOG.md
        shell: bash
        env:
          GITHUB_REF_NAME: ${{ env.BASE_TAG }}
          IS_HOTFIX: ${{ env.IS_HOTFIX }}

      - name: Build Executable with Nuitka
        run: |
          python -m nuitka `
          --onefile `
          --windows-console-mode=disable `
          --enable-plugin=tk-inter `
          --include-package=ttkbootstrap,httpx,aiofiles,vdf `
          --include-module=backend_gui `
          --include-module=version  # 确保version.py被打包进可执行文件
          --assume-yes-for-downloads `
          frontend_gui.py
        shell: pwsh

      - name: Rename Artifact (with Version Tag)
        run: |
          $baseTag = "${{ env.BASE_TAG }}"
          $isHotfix = "${{ env.IS_HOTFIX }}" -eq "true"
          if ($isHotfix) {
            ren frontend_gui.exe "Cai-Installer-Gui_${baseTag}_hotfix.exe"
          } else {
            ren frontend_gui.exe "Cai-Installer-Gui_${baseTag}.exe"
          }
        shell: pwsh

      - name: Upload Artifacts to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.IS_HOTFIX == 'true' && 'Cai-Installer-Gui_${{ env.BASE_TAG }}_hotfix.exe' || 'Cai-Installer-Gui_${{ env.BASE_TAG }}.exe' }}
          body_path: CHANGELOG.md
          name: ${{ env.BASE_TAG }} ${{ env.IS_HOTFIX == 'true' && '(Hotfix)' || '' }}
          tag_name: ${{ env.BASE_TAG }}
