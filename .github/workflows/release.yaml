name: Build & Release

on:
  release:
    types: [published]
    tags:
      - "v*.*.*"

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write # å…è®¸ä¸Šä¼ å‘å¸ƒå†…å®¹å’Œæäº¤ä»£ç 

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ç¡®ä¿è·å–å®Œæ•´çš„å†å²å’Œæ ‡ç­¾
          persist-credentials: true # ä¿ç•™å‡­æ®ç”¨äºåç»­æäº¤

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: |
            %LocalAppData%\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Generate version.py
        run: |
          # ä»æ ‡ç­¾æå–ç‰ˆæœ¬å·ï¼ˆå»é™¤å‰ç¼€vï¼‰
          $version = "${{ github.ref_name }}".TrimStart('v')
          # åˆ›å»ºversion.pyæ–‡ä»¶
          "__version__ = '$version'" | Out-File -FilePath version.py -Encoding utf8
          # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶å†…å®¹ï¼ˆç”¨äºéªŒè¯ï¼‰
          Get-Content version.py
        shell: pwsh

      - name: Commit version.py
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add version.py
          git commit -m "ğŸ”§ chore: update version to ${{ github.ref_name }}"
          git push origin HEAD:main
        shell: bash
        continue-on-error: true # å³ä½¿æäº¤å¤±è´¥ä¹Ÿä¸ä¸­æ–­å·¥ä½œæµï¼ˆå¦‚æ–‡ä»¶æ— å˜åŒ–æ—¶ï¼‰

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          architecture: "x64"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate Changelog
        run: |
          python scripts/generate_changelog.py "${{ github.ref_name }}" > CHANGELOG.md
        shell: bash
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}

      - name: Build Executable with Nuitka
        run: |
          # æ„å»ºå‘½ä»¤
          python -m nuitka `
          --onefile `
          --windows-console-mode=disable `
          --enable-plugin=tk-inter `
          --include-package=ttkbootstrap,httpx,aiofiles,vdf `
          --include-module=backend_gui `
          --include-module=version `
          --assume-yes-for-downloads `
          --follow-imports `
          frontend_gui.py
        shell: pwsh

      - name: Clean up old build artifacts
        run: |
          # åˆ é™¤æ—§çš„æ„å»ºæ–‡ä»¶ï¼Œä½†ä¿ç•™æ–°ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶
          if (Test-Path "frontend_gui.onefile-build") { Remove-Item -Recurse -Force "frontend_gui.onefile-build" }
          if (Test-Path "frontend_gui.build") { Remove-Item -Recurse -Force "frontend_gui.build" }
          # é‡å‘½åå¯æ‰§è¡Œæ–‡ä»¶
          if (Test-Path "frontend_gui.exe") { 
            Move-Item "frontend_gui.exe" "Cai-Installer-Gui.exe"
          }
          # æ¸…ç†distç›®å½•ï¼ˆå¦‚æœéœ€è¦ï¼‰
          if (Test-Path "frontend_gui.dist") { Remove-Item -Recurse -Force "frontend_gui.dist" }
        shell: pwsh

      - name: Upload Artifacts to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            Cai-Installer-Gui.exe
          body_path: CHANGELOG.md
          name: ${{ github.ref_name }} # å‘å¸ƒåç§°ä¸æ ‡ç­¾åŒ¹é…
