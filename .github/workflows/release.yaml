name: Build & Release

on:
  release:
    types: [published]
    tags:
      - "v*.*.*"
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write # å…è®¸ä¸Šä¼ å‘å¸ƒå†…å®¹å’Œæäº¤ä»£ç 

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ç¡®ä¿è·å–å®Œæ•´çš„å†å²å’Œæ ‡ç­¾
          persist-credentials: true # ä¿ç•™å‡­æ®ç”¨äºåç»­æäº¤

      - name: Generate version.py
        run: |
          # ä»æ ‡ç­¾æå–ç‰ˆæœ¬å·ï¼ˆå»é™¤å‰ç¼€vï¼‰
          $version = "${{ github.ref_name }}".TrimStart('v')
          # åˆ›å»ºversion.pyæ–‡ä»¶
          "__version__ = '$version'" | Out-File -FilePath version.py -Encoding utf8
          # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶å†…å®¹ï¼ˆç”¨äºéªŒè¯ï¼‰
          Get-Content version.py
        shell: pwsh

      - name: Commit version.py
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add version.py
          git commit -m "ğŸ”§ chore: update version.py to ${{ github.ref_name }} [skip ci]"
          git push
        shell: bash
        continue-on-error: true # å³ä½¿æäº¤å¤±è´¥ä¹Ÿä¸ä¸­æ–­å·¥ä½œæµï¼ˆå¦‚æ–‡ä»¶æ— å˜åŒ–æ—¶ï¼‰

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          architecture: "x64"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate Changelog
        run: |
          python scripts/generate_changelog.py "${{ github.ref_name }}" > CHANGELOG.md
        shell: bash
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}

      - name: Build Executable with Nuitka
        run: |
          python -m nuitka `
          --onefile `
          --windows-console-mode=disable `
          --enable-plugin=tk-inter `
          --include-package=ttkbootstrap,httpx,aiofiles,vdf `
          --include-module=backend_gui `
          --include-module=version `
          --assume-yes-for-downloads `
          frontend_gui.py
        shell: pwsh

      - name: Rename Artifact (with Version Tag)
        run: |
          ren frontend_gui.exe "Cai-Installer-Gui_${{ github.ref_name }}.exe"
        shell: pwsh
        # github.ref_name å°†ä¼šæ˜¯ç±»ä¼¼ v1.2.3 çš„æ ‡ç­¾å
      - name: Upload Artifacts to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            Cai-Installer-Gui_${{ github.ref_name }}.exe
          body_path: CHANGELOG.md
          name: ${{ github.ref_name }} # å‘å¸ƒåç§°ä¸æ ‡ç­¾åŒ¹é…
